# HTTP
ssl_session_cache               shared:SSL:10m;
ssl_session_timeout             10m;

# Main game website
server {
    listen                      80;
    listen                      [::]:80;
    listen                      443 ssl http2;
    listen                      [::]:443 ssl http2;
    server_name                 ${GAME_DOMAIN};
    keepalive_timeout           70;
    ###########################################
    ssl_certificate             /etc/nginx/ssl/$ssl_server_name.crt;
    ssl_certificate_key         /etc/nginx/ssl/$ssl_server_name.key;
    ssl_ciphers                 EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    ###########################################
    gzip                        on;
    gzip_static                 on;
    gzip_vary                   on;
    gzip_http_version           1.1;
    gzip_min_length             256;
    gzip_comp_level             5;
    gzip_proxied                any;
    gzip_types
      application/atom+xml
      application/javascript
      application/json
      application/rss+xml
      application/vnd.ms-fontobject
      application/x-font-ttf
      application/x-web-app-manifest+json
      application/xhtml+xml
      application/xml
      font/opentype
      image/svg+xml
      image/x-icon
      text/css
      text/plain
      text/x-component;
    client_max_body_size        250m;
    proxy_connect_timeout       600;
    proxy_send_timeout          600;
    proxy_read_timeout          600;
    send_timeout                600;
    ###########################################
    error_log                   /var/log/nginx/error.log;
    access_log                  /var/log/nginx/access.log;
    ###########################################
    root                        /var/www/html/site/public;
    index                       index.php index.html index.htm;
    error_page                  404 /index.php;
    add_header                  X-Frame-Options "SAMEORIGIN";
    add_header                  X-XSS-Protection "1; mode=block";
    ###########################################
    # Nginx reverse web proxy paths
    location / {
        proxy_cache_valid 200 30m;
        proxy_cache_valid 404 1m;
        proxy_pass http://node:3000;
    }
    location ^~ /wiki {
        fastcgi_cache_valid     200 204 1m;
        fastcgi_cache_valid     404 204 1m;
        fastcgi_no_cache        $http_authorization $cookie_laravel_session;
        fastcgi_cache_lock      on;
        fastcgi_cache_lock_timeout 10s;
        add_header              X-Proxy-Cache $upstream_cache_status;
        fastcgi_no_cache        $no_cache;
        fastcgi_cache_use_stale updating error timeout invalid_header http_500;
        fastcgi_ignore_headers  Cache-Control Expires Set-Cookie;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        Host $http_host;
        fastcgi_pass            php:9000;
        fastcgi_index           index.php;
        include                 fastcgi_params;
        fastcgi_buffers         16 16k;
        fastcgi_buffer_size     32k;
        fastcgi_read_timeout    900s;
        fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param           PATH_INFO $fastcgi_path_info;
        fastcgi_param           DOCUMENT_ROOT $realpath_root;
        try_files               $uri $uri/ =404;
    }
    location ^~ /sql {
        fastcgi_cache_valid     200 204 1m;
        fastcgi_cache_valid     404 204 1m;
        fastcgi_no_cache        $http_authorization $cookie_laravel_session;
        fastcgi_cache_lock      on;
        fastcgi_cache_lock_timeout 10s;
        add_header              X-Proxy-Cache $upstream_cache_status;
        fastcgi_no_cache        $no_cache;
        fastcgi_cache_use_stale updating error timeout invalid_header http_500;
        fastcgi_ignore_headers  Cache-Control Expires Set-Cookie;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        Host $http_host;
        fastcgi_pass            php:9000;
        fastcgi_index           index.php;
        include                 fastcgi_params;
        fastcgi_buffers         16 16k;
        fastcgi_buffer_size     32k;
        fastcgi_read_timeout    900s;
        fastcgi_param           SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param           PATH_INFO $fastcgi_path_info;
        fastcgi_param           DOCUMENT_ROOT $realpath_root;
        try_files               $uri $uri/ =404;
    }
    ###########################################
    # Cache everything by default
    set                         $no_cache 0;
    # Don't cache POST requests
    if                          ($request_method = POST) {
        set                     $no_cache 1;
    }
    # Don't cache if the URL contains a query string
    if                          ($query_string != "") {
        set                     $no_cache 1;
    }
    # Don't cache the following URLs
    if                          ($request_uri ~* "/(cp/)") {
        set                     $no_cache 1;
    }
    # Don't cache if there is a cookie called PHPSESSID
    if                          ($http_cookie = "PHPSESSID") {
        set                     $no_cache 1;
    }
    ###########################################
    location                    /favicon.ico { access_log off; log_not_found off; }
    location                    /robots.txt  { access_log off; log_not_found off; }
    location                    ~* \.(jpg|jpeg|png|gif|ico|css|js|eot|ttf|woff|woff2)$ {
        expires                 max;
        add_header              Cache-Control public;
        add_header              Access-Control-Allow-Origin *;
        access_log              off;
        try_files               $uri $uri/ /index.php?$query_string;
    }
    ###########################################
	# Deny access to hidden files
    location                    ~ /\. {
        deny                    all;
        internal;
    }
    # Deny access to version control system directories.
	location                    ~ /\.svn|/\.git {
		deny                    all;
		internal;
	}
    location                    ~ /\.(?!well-known).* {
        deny                    all;
    }
}
